# 达梦数据库(DM Database) Grammar 实现

本实现完全参考 PostgreSQL Grammar 的结构，适配达梦数据库的特殊语法。

## 文件结构

```
grammar/dameng/
├── dameng.go      # 主实现文件：驱动注册、类型映射
├── quoter.go      # 标识符引用（双引号）和占位符（?）
├── compile.go     # 查询编译（ROWNUM分页）
├── insert.go      # 插入操作（RETURNING支持）
├── update.go      # 更新和Upsert操作
├── delete.go      # 删除和Truncate操作
├── builder.go     # SQL构建辅助方法
├── schema.go      # Schema管理（表、列、索引）
└── README.md      # 本文件
```

## 核心特性

### 1. 标识符引用

- 使用**双引号** `"` 作为标识符引用（类似PostgreSQL和Oracle）
- 避免大小写问题：`SELECT "id" FROM "users"`

### 2. 占位符

- 使用 `?` 占位符（不是PostgreSQL的`$1`, `$2`）
- 符合达梦官方Go驱动规范

### 3. ROWNUM分页

达梦数据库使用ROWNUM进行分页（类似Oracle）：

```sql
-- 只有LIMIT (10条)
SELECT * FROM (原始查询) WHERE ROWNUM <= 10

-- LIMIT + OFFSET (跳过20条取10条)
SELECT * FROM (
  SELECT t.*, ROWNUM rn FROM (原始查询) t 
  WHERE ROWNUM <= 30
) WHERE rn > 20
```

### 4. 数据类型映射

| Xun类型 | 达梦类型 | 说明 |
|---------|---------|------|
| string | VARCHAR2 | 类似Oracle |
| text | CLOB | 大文本 |
| binary | BLOB | 二进制 |
| boolean | BIT | 布尔值 |
| decimal | NUMBER | 精确数值 |
| integer | INTEGER | 整数 |
| timestamp | TIMESTAMP | 时间戳 |

### 5. 自增列

使用IDENTITY语法（DM8+）：

```sql
CREATE TABLE users (
  id INTEGER GENERATED BY DEFAULT AS IDENTITY,
  name VARCHAR2(100)
)
```

### 6. 锁机制

- 支持：`FOR UPDATE`
- 不支持：`FOR SHARE`（自动转换为FOR UPDATE）

### 7. INSERT RETURNING

达梦数据库支持RETURNING子句获取自增ID：

```sql
INSERT INTO users (name) VALUES (?) RETURNING "id"
```

### 8. UPSERT

使用ON CONFLICT语法（DM8+，类似PostgreSQL）：

```sql
INSERT INTO users (id, name) VALUES (?, ?)
ON CONFLICT (id) DO UPDATE SET name=excluded.name
```

### 9. Schema查询

使用达梦数据库系统表：

- `ALL_TABLES` - 查询表信息
- `ALL_TAB_COLUMNS` - 查询列信息
- `ALL_INDEXES` - 查询索引信息
- `ALL_IND_COLUMNS` - 查询索引列信息
- `V$VERSION` - 查询版本信息

## 方法签名参考

所有方法签名完全参考PostgreSQL Grammar实现：

### 查询编译

```go
CompileSelect(query *dbal.Query) string
CompileSelectOffset(query *dbal.Query, offset *int) string
CompileColumns(query *dbal.Query, columns []interface{}, bindingOffset *int) string
CompileLock(query *dbal.Query, lock interface{}) string
```

### 插入操作

```go
CompileInsertGetID(query *dbal.Query, columns []interface{}, values [][]interface{}, sequence string) (string, []interface{})
ProcessInsertGetID(sql string, bindings []interface{}, sequence string) (int64, error)
CompileInsertOrIgnore(query *dbal.Query, columns []interface{}, values [][]interface{}) (string, []interface{})
```

### 更新操作

```go
CompileUpdate(query *dbal.Query, values map[string]interface{}) (string, []interface{})
CompileUpsert(query *dbal.Query, columns []interface{}, values [][]interface{}, uniqueBy []interface{}, updateValues interface{}) (string, []interface{})
Upsert(query *dbal.Query, values []xun.R, uniqueBy []interface{}, updateValues interface{}) (sql.Result, error)
```

### 删除操作

```go
CompileDelete(query *dbal.Query) (string, []interface{})
CompileTruncate(query *dbal.Query) ([]string, [][]interface{})
```

### Schema管理

```go
GetVersion() (*dbal.Version, error)
GetTables() ([]string, error)
TableExists(name string) (bool, error)
CreateTable(table *dbal.Table, options ...dbal.CreateTableOption) error
AlterTable(table *dbal.Table) error
RenameTable(old string, new string) error
DropTable(name string) error
DropTableIfExists(name string) error
GetTable(name string) (*dbal.Table, error)
GetColumnListing(dbName string, tableName string) ([]*dbal.Column, error)
GetIndexListing(dbName string, tableName string) ([]*dbal.Index, error)
```

### SQL构建器

```go
SQLAddColumn(column *dbal.Column) string
SQLAddComment(column *dbal.Column) string
SQLAddIndex(index *dbal.Index) string
SQLAddPrimary(primary *dbal.Primary) string
```

## 与PostgreSQL的主要差异

| 特性 | PostgreSQL | 达梦数据库 | 说明 |
|------|-----------|-----------|------|
| 占位符 | `$1`, `$2` | `?` | 驱动差异 |
| 分页 | LIMIT OFFSET | ROWNUM | 语法差异 |
| 标识符 | `"name"` | `"name"` | 相同 |
| 字符串类型 | VARCHAR | VARCHAR2 | 类似Oracle |
| 大文本 | TEXT | CLOB | 类似Oracle |
| 自增列 | SERIAL | IDENTITY | 语法差异 |
| 锁 | FOR SHARE | 不支持 | 功能限制 |
| UPSERT | ON CONFLICT | ON CONFLICT | DM8+支持 |
| 系统表 | information_schema | ALL_* | 查询方式不同 |

## 使用示例

```go
import (
    "github.com/yaoapp/xun/capsule"
    _ "github.com/yaoapp/xun/grammar/dameng"
)

// 连接达梦数据库
capsule.Add("default", "dameng", "dm://SYSDBA:SYSDBA@localhost:5236/DAMENG")

// 使用Query Builder
query := capsule.Query()
users, err := query.Table("users").
    Where("age", ">", 18).
    Limit(10).
    Offset(20).
    Get()

// 使用Schema Builder
schema := capsule.Schema()
err = schema.CreateTable("posts", func(table schema.Blueprint) {
    table.ID("id")
    table.String("title", 200)
    table.Text("content")
    table.Timestamps()
})
```

## 兼容性

- **达梦数据库版本**: DM8.x (推荐)
- **Go驱动**: `gitee.com/chunanyong/dm`
- **测试状态**: 待实际数据库测试

## 注意事项

1. **表名大小写**：达梦数据库默认将未引用的标识符转为大写，本实现统一使用双引号包裹所有标识符避免此问题

2. **ROWNUM性能**：深度分页可能存在性能问题，建议使用游标或其他方式优化

3. **RETURNING支持**：需要达梦数据库8.0+版本

4. **ON CONFLICT**：UPSERT功能需要达梦数据库8.0+版本，如使用7.x版本可能需要改用MERGE INTO语法

5. **系统表权限**：查询系统表需要相应的权限，确保连接用户有访问ALL_*视图的权限

## 开发参考

- 参考实现：`grammar/postgres/`
- 代码风格：完全遵循PostgreSQL Grammar的结构和命名
- 方法签名：与PostgreSQL保持一致，便于维护

## 测试

```bash
# 设置测试环境变量
export XUN_UNIT_DRIVER="dameng"
export XUN_UNIT_SOURCE="dm://SYSDBA:SYSDBA@localhost:5236/DAMENG"

# 运行测试（需要实际达梦数据库环境）
go test -v ./grammar/dameng/
```

## 贡献

欢迎提交Issue和Pull Request改进达梦数据库支持！
