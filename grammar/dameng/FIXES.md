# 达梦数据库适配修复总结

## 基于 GORM 实现的对比分析

本次修复基于对 `docs/gorm.md` 中 GORM 达梦适配实现的分析，修正了我们的 `grammar/dameng` 实现中的多个关键问题。

## ✅ 已修复的问题

### 1. **分页语法** (compile.go)
- **问题**: 使用了复杂的 Oracle 风格 ROWNUM 分页
- **修复**: 改用标准 SQL `LIMIT/OFFSET` 语法（达梦 DM8+ 支持）
- **GORM参考**: line 239-256

```go
// 修复前（ROWNUM风格）
select * from (select t.*, ROWNUM rn from (...) t where ROWNUM <= %d) where rn > %d

// 修复后（标准SQL）
SELECT ... FROM ... LIMIT 10 OFFSET 5
```

### 2. **DISTINCT ON 语法** (compile.go:89)
- **问题**: 使用了 PostgreSQL 特有的 `DISTINCT ON (columns)` 语法
- **修复**: 改为标准的 `DISTINCT` 语法
- **原因**: 达梦数据库不支持 `DISTINCT ON`

```go
// 修复前
select distinct on (column1, column2) ...

// 修复后
select distinct ...
```

### 3. **DUAL 表支持** (compile.go:120)
- **问题**: 缺失对 DUAL 虚拟表的支持
- **修复**: 添加 `SelectFromDummyTable()` 方法返回 `"from DUAL"`
- **GORM参考**: line 258-260
- **原因**: 某些不带 FROM 子句的 SELECT 需要 DUAL 表（Oracle/DM 特性）

### 4. **Upsert 语法** (update.go:45)
- **问题**: 使用了 PostgreSQL 的 `ON CONFLICT` 语法
- **修复**: 改为 `ON DUPLICATE KEY UPDATE`（MySQL/DM 兼容）
- **备注**: 如果不支持，可能需要改用 `MERGE INTO`（Oracle风格）

```go
// 修复前
INSERT ... ON CONFLICT (id) DO UPDATE SET ...

// 修复后
INSERT ... ON DUPLICATE KEY UPDATE ...
```

## ⚠️ 需要实际测试验证的问题

### 1. **自增列语法** (builder.go:42-47)
当前实现使用 SQL 标准语法：
```go
BIGINT GENERATED BY DEFAULT AS IDENTITY
INTEGER GENERATED BY DEFAULT AS IDENTITY
```

GORM 使用 SQL Server 兼容语法：
```go
BIGINT IDENTITY(1,1)
INT IDENTITY(1,1)
```

**建议**: 需要在实际达梦数据库上测试两种语法，确认哪种有效。

### 2. **VARCHAR vs VARCHAR2** (dameng.go:84)
- 我们使用: `VARCHAR2`（Oracle风格）
- GORM 使用: `VARCHAR`（标准SQL）

**建议**: 确认达梦推荐使用哪种。两种都可能有效。

### 3. **系统表查询** (schema.go)
我们使用 Oracle 兼容视图：
- `ALL_TABLES`
- `ALL_TAB_COLUMNS`
- `ALL_INDEXES`

GORM 使用底层系统表：
- `SYS.SYSOBJECTS`
- `SYS.SYSINDEXES`
- `SYS.SYSCOLUMNS`

**建议**: 我们的方式更简洁，应该优先使用。如果有问题再改用底层系统表。

### 4. **事务与锁** (compile.go:107)
当前实现：
- 支持 `FOR UPDATE`
- 不支持 `FOR SHARE`（统一使用 FOR UPDATE）

这与 GORM 行为一致，应该没有问题。

## ⭐ 缺失但可选的功能

### 1. **IDENTITY_INSERT 支持** (低优先级)
GORM 实现了 `SET IDENTITY_INSERT table ON/OFF` 支持（line 27-49），用于显式插入自增ID。

这在数据迁移场景很有用，但不是核心功能。可以在需要时再添加。

### 2. **复杂的索引/外键查询**
GORM 实现了非常复杂的索引和外键检查查询（line 150-198），我们使用更简单的实现。

当前实现应该足够，除非遇到具体问题。

## 🧪 测试建议

### 必须测试的功能
1. **分页查询**: `SELECT * FROM users LIMIT 10 OFFSET 5`
2. **DISTINCT 查询**: `SELECT DISTINCT column FROM table`
3. **自增列创建**: 确认 IDENTITY 语法
4. **UPSERT 操作**: 确认 ON DUPLICATE KEY UPDATE 支持
5. **DUAL 表**: `SELECT 1 FROM DUAL`

### 测试环境变量
```bash
export XUN_UNIT_DRIVER="dameng"
export XUN_UNIT_SOURCE="dm://SYSDBA:SYSDBA@localhost:5236"
export XUN_UNIT_NAME="DM8"
export XUN_UNIT_LOG="/tmp/dameng.log"

# 运行测试
go test -v ./dbal/schema/
go test -v ./dbal/query/
```

### 推荐测试顺序
1. 连接测试
2. 建表测试（测试自增列语法）
3. 插入/查询测试
4. 分页测试（LIMIT/OFFSET）
5. DISTINCT 测试
6. UPSERT 测试
7. 事务测试

## 📝 与其他数据库的对比

| 特性 | MySQL | PostgreSQL | Oracle | 达梦 (DM) |
|------|-------|------------|--------|-----------|
| 标识符引用 | \` | " | " | " |
| 占位符 | ? | $1, $2 | :1, :2 | ? |
| 自增列 | AUTO_INCREMENT | SERIAL | IDENTITY | IDENTITY |
| 分页 | LIMIT/OFFSET | LIMIT/OFFSET | ROWNUM | LIMIT/OFFSET (DM8+) |
| UPSERT | ON DUPLICATE KEY | ON CONFLICT | MERGE INTO | ON DUPLICATE KEY / MERGE INTO |
| 虚拟表 | - | - | DUAL | DUAL |
| 数据类型 | VARCHAR | VARCHAR | VARCHAR2 | VARCHAR/VARCHAR2 |

## 🎯 结论

经过与 GORM 实现的对比分析和修复，我们的达梦适配器现在：

✅ 编译通过  
✅ 静态分析通过  
✅ 语法更符合达梦特性  
✅ 移除了不兼容的 PostgreSQL 特性  
✅ 添加了必要的 Oracle 兼容特性  

**下一步**: 在实际达梦数据库环境中进行功能测试，根据测试结果调整自增列和 UPSERT 语法。
