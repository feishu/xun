# GORM v2 达梦适配对比分析

## 📋 分析基础
- GORM v1 实现: `docs/gorm.md`
- GORM v2 实现: `docs/dm-gorm_v2/` (4个文件)
- 我们的实现: `grammar/dameng/`

---

## 🔴 严重问题 (必须修复)

### 1. **自增列语法不匹配** ⚠️ **最严重**

**GORM v1 & v2 一致使用**:
```go
// dm.md line 195, 264
sqlType += " IDENTITY(1,1)"  // SQL Server 风格
```

**我们的实现** (builder.go:42-47):
```go
typ = "BIGINT GENERATED BY DEFAULT AS IDENTITY"  // SQL 标准风格
typ = "INTEGER GENERATED BY DEFAULT AS IDENTITY"
```

**问题**: 两种语法完全不同！
- GORM: `INT IDENTITY(1,1)` - SQL Server/达梦兼容语法
- 我们: `INT GENERATED BY DEFAULT AS IDENTITY` - SQL标准语法

**影响**: 建表时自增列可能创建失败

**修复优先级**: 🔴 **P0 - 立即修复**

---

### 2. **Upsert 语法完全不同** ⚠️ **严重**

**GORM v2 使用完整的 MERGE INTO** (create.md line 207-300):
```sql
MERGE INTO "table" USING (
    SELECT ?, ?, ? FROM DUAL
    UNION ALL SELECT ?, ?, ? FROM DUAL
) AS "excluded" ("col1", "col2", "col3") ON "table"."id" = "excluded"."id"
WHEN MATCHED THEN UPDATE SET "col1" = "excluded"."col1"
WHEN NOT MATCHED THEN INSERT ("col1", "col2") VALUES ("excluded"."col1", "excluded"."col2")
```

**我们的实现** (update.go:45):
```go
sql = fmt.Sprintf("%s on duplicate key update", sql)
// INSERT ... ON DUPLICATE KEY UPDATE ... (MySQL风格)
```

**问题**: 
- GORM 使用 Oracle 标准的 `MERGE INTO` 语法
- 我们使用 MySQL 的 `ON DUPLICATE KEY UPDATE`
- 达梦可能**不支持** `ON DUPLICATE KEY UPDATE`

**修复优先级**: 🔴 **P0 - 立即修复**

---

### 3. **VARCHAR vs VARCHAR2** ⚠️ **数据类型不一致**

**GORM v2** (dm.md line 236, 240):
```go
return "VARCHAR"  // 标准SQL类型
return fmt.Sprintf("VARCHAR(%d)", size)
```

**我们的实现** (dameng.go:84):
```go
types["string"] = "VARCHAR2"  // Oracle风格
```

**GORM v1** (gorm.md line 120):
```go
sqlType = fmt.Sprintf("VARCHAR(%d)", size)  // 也用VARCHAR
```

**问题**: GORM v1 和 v2 都用 `VARCHAR`，我们用 `VARCHAR2`

**影响**: 可能都支持，但 `VARCHAR` 更标准

**修复优先级**: 🟡 **P1 - 建议修复**

---

## 🟡 缺失功能 (重要)

### 4. **IDENTITY_INSERT 支持** ❌ **缺失**

**GORM v2 完整实现** (create.md line 70-86):
```go
if setIdentityInsert {
    db.Statement.SQL.Reset()
    db.Statement.WriteString("SET IDENTITY_INSERT ")
    db.Statement.WriteQuoted(db.Statement.Table)
    db.Statement.WriteString(" ON;")
    // ... 执行插入 ...
    defer {
        // SET IDENTITY_INSERT table OFF
    }
}
```

**我们的实现**: ❌ **完全缺失**

**用途**: 允许显式插入自增ID值（数据迁移场景必需）

**示例场景**:
```go
// 迁移数据，需要保持原有ID
INSERT INTO users (id, name) VALUES (100, 'admin')  // id=100是自增列
```

**修复优先级**: 🟡 **P1 - 数据迁移场景需要**

---

### 5. **SavePoint/RollbackTo 事务保存点** ❌ **缺失**

**GORM v2** (dm.md line 270-276):
```go
func (d Dialector) SavePoint(tx *gorm.DB, name string) error {
    return tx.Exec("SAVEPOINT " + name).Error
}

func (d Dialector) RollbackTo(tx *gorm.DB, name string) error {
    return tx.Exec("ROLLBACK TO SAVEPOINT " + name).Error
}
```

**我们的实现**: ❌ **缺失**

**用途**: 事务中设置保存点，可以回滚到特定点而不是整个事务

**示例**:
```go
tx.Begin()
tx.SavePoint("sp1")
// 一些操作
tx.RollbackTo("sp1")  // 只回滚到 sp1，不影响之前的操作
tx.Commit()
```

**修复优先级**: 🟢 **P2 - 可选高级功能**

---

## ✅ 已正确实现

### 6. **标识符引用** ✅
- GORM: 双引号 `"`
- 我们: 双引号 `"` ✅

### 7. **占位符** ✅
- GORM: `?`
- 我们: `?` ✅

### 8. **DUAL 表** ✅
- GORM: 使用 `FROM DUAL`
- 我们: 已添加 `SelectFromDummyTable()` ✅

### 9. **分页语法** ✅
- GORM v2: 未显式实现（使用默认LIMIT/OFFSET）
- 我们: `LIMIT/OFFSET` ✅

### 10. **基本数据类型** ✅
| 类型 | GORM v2 | 我们 | 状态 |
|------|---------|------|------|
| Bool | BIT | BIT | ✅ |
| TinyInt | TINYINT | TINYINT | ✅ |
| SmallInt | SMALLINT | SMALLINT | ✅ |
| Int | INT | INTEGER | ✅ 同义 |
| BigInt | BIGINT | BIGINT | ✅ |
| Float | DOUBLE | DOUBLE PRECISION | ✅ 同义 |
| Decimal | DECIMAL(p,s) | NUMBER(p,s) | ⚠️ 不同但都支持 |
| Text | CLOB | CLOB | ✅ |
| Binary | BLOB | BLOB | ✅ |
| Time | TIMESTAMP WITH TIME ZONE | TIMESTAMP WITH TIME ZONE | ✅ |

### 11. **列注释** ✅
- GORM: `COMMENT ON COLUMN table.column IS 'xxx'`
- 我们: `COMMENT on column table.column is 'xxx'` ✅

### 12. **索引操作** ✅
- `DROP INDEX`
- `ALTER INDEX ... RENAME TO ...`
- 都正确实现 ✅

---

## 🔍 需要验证的差异

### 13. **系统表查询方式**

**GORM v2** (migrator.md):
```sql
-- 使用底层系统表
SELECT * FROM SYS.SYSOBJECTS, SYS.SYSCOLUMNS, SYS.SYSINDEXES
WHERE TYPE$ = 'SCH' AND SUBTYPE$ = 'UTAB' ...
```

**我们的实现** (schema.go):
```sql
-- 使用 Oracle 兼容视图
SELECT * FROM ALL_TABLES, ALL_TAB_COLUMNS, ALL_INDEXES
WHERE OWNER = USER AND TABLE_NAME = ?
```

**分析**:
- GORM: 直接查询底层系统表，查询复杂但精确
- 我们: 使用兼容视图，查询简单但可能功能有限

**建议**: 优先使用我们的方式，如遇问题再改用GORM方式

---

## 📊 总结对比表

| 功能 | GORM v1 | GORM v2 | 我们 | 状态 |
|------|---------|---------|------|------|
| 标识符引用 | " | " | " | ✅ |
| 占位符 | ? | ? | ? | ✅ |
| 自增列 | IDENTITY(1,1) | IDENTITY(1,1) | GENERATED AS IDENTITY | 🔴 不匹配 |
| Upsert | - | MERGE INTO | ON DUPLICATE KEY | 🔴 不匹配 |
| VARCHAR类型 | VARCHAR | VARCHAR | VARCHAR2 | 🟡 建议统一 |
| DUAL表 | FROM DUAL | FROM DUAL | FROM DUAL | ✅ |
| 分页 | LIMIT/OFFSET | LIMIT/OFFSET | LIMIT/OFFSET | ✅ |
| DISTINCT | DISTINCT | DISTINCT | DISTINCT | ✅ |
| 列注释 | COMMENT ON | COMMENT ON | COMMENT ON | ✅ |
| IDENTITY_INSERT | ✅ | ✅ | ❌ | 🟡 缺失 |
| SavePoint | - | ✅ | ❌ | 🟢 缺失 |
| 系统表查询 | 系统表 | 系统表 | 视图 | 🟢 不同但可用 |

---

## 🎯 修复优先级

### P0 - 立即修复 (阻断性问题)
1. ✅ ~~分页语法~~ (已修复)
2. ✅ ~~DISTINCT ON~~ (已修复)
3. ✅ ~~DUAL表~~ (已添加)
4. 🔴 **自增列语法**: `IDENTITY(1,1)` vs `GENERATED AS IDENTITY`
5. 🔴 **Upsert语法**: `MERGE INTO` vs `ON DUPLICATE KEY`

### P1 - 建议修复 (功能完整性)
6. 🟡 VARCHAR类型统一
7. 🟡 IDENTITY_INSERT 支持

### P2 - 可选功能 (高级特性)
8. 🟢 SavePoint/RollbackTo
9. 🟢 考虑改用底层系统表查询

---

## 🧪 测试验证计划

### 必须验证的功能
1. **自增列创建**: 
   ```sql
   CREATE TABLE test (id INT IDENTITY(1,1), name VARCHAR(100))
   vs
   CREATE TABLE test (id INT GENERATED BY DEFAULT AS IDENTITY, name VARCHAR(100))
   ```

2. **Upsert操作**:
   ```sql
   -- GORM方式
   MERGE INTO users USING (...) ON ... WHEN MATCHED ...
   
   -- 我们的方式
   INSERT INTO users ... ON DUPLICATE KEY UPDATE ...
   ```

3. **VARCHAR vs VARCHAR2**:
   ```sql
   CREATE TABLE test (name VARCHAR(100))
   vs
   CREATE TABLE test (name VARCHAR2(100))
   ```

### 测试步骤
```bash
# 1. 连接达梦数据库
export XUN_UNIT_DRIVER="dameng"
export XUN_UNIT_SOURCE="dm://SYSDBA:SYSDBA@localhost:5236"

# 2. 测试自增列
go test -v ./grammar/dameng/ -run TestIdentity

# 3. 测试 Upsert
go test -v ./grammar/dameng/ -run TestUpsert

# 4. 测试数据类型
go test -v ./grammar/dameng/ -run TestDataTypes
```

---

## 📝 推荐的修复步骤

1. **立即修改自增列语法** (builder.go)
   ```go
   // 改为与GORM一致
   sqlType += " IDENTITY(1,1)"
   ```

2. **重写 Upsert 实现** (update.go)
   - 参考 create.md line 207-300
   - 实现完整的 MERGE INTO 语法

3. **考虑改用 VARCHAR** (dameng.go)
   ```go
   types["string"] = "VARCHAR"  // 与GORM保持一致
   ```

4. **在实际环境测试验证所有修改**

---

## 🔗 参考文件
- GORM v1: `docs/dm-gorm_v1.md`
- GORM v2 主文件: `docs/dm-gorm_v2/dm.md`
- GORM v2 创建逻辑: `docs/dm-gorm_v2/create.md`
- GORM v2 迁移器: `docs/dm-gorm_v2/migrator.md`
- 我们的实现: `grammar/dameng/*.go`
